<script>
    $(function () {
        $('#run-check').click(runGrammarCheck);
        refreshLanguagesList();
    });

    function refreshLanguagesList() {
        var runButton = $('#run-check')
        runButton.disabled = true
        var select = $('select[name="language"]')
        select.disabled = true

        google.script.run
            .withSuccessHandler(
                function (result, element) {
                    var languages = result.available.grammar
                    element.empty()
                    for (var lang in languages) {
                        element.append(new Option(languages[lang], lang))
                    }
                    runButton.disabled = false
                })
            .withFailureHandler(
                function (msg, element) {
                    showError(msg, element)
                })
            .withUserObject(select)
            .apiRequestLanguageOptions();
    }

    function runGrammarCheck() {
        this.disabled = true;
        $('#error').remove();

        var lang = $('select[name="language"] option:selected').val();
        google.script.run
            .withSuccessHandler(
                function (grammarCheckResultsHtml, element) {
                    element.disabled = false;
                    $('#results').html(grammarCheckResultsHtml);
                    $('.suggestion').click(runCorrection);
                })
            .withFailureHandler(
                function (msg, element) {
                    showError(msg, $('#button-bar'));
                    element.disabled = false;
                })
            .withUserObject(this)
            .runGrammarCheckOnWholeText(lang);
    }

    function runCorrection() {
        var errorText = $(this).attr('data-error-text');
        var correction = $(this).attr('data-correction');
        var parentIndex = $(this).attr('data-parent-index');
        var parent = $(this).closest('.grammar-error');

        google.script.run
            .withSuccessHandler(function () {
                parent.slideUp(300, function () {
                    runGrammarCheck();
                    parent.remove();
                });
            })
            .withFailureHandler(function (message) {
                showError(message, this);
            })
            .withUserObject(this)
            .runCorrection(errorText, correction);
    }

    function showError(msg, element) {
        var div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
    }
</script>