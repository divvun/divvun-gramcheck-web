<script>
    $(function () {
        $('#run-check').click(runGrammarCheck);
        $('#open-preferences').click(openPreferences);
        $('select[name="language"]').change(selectedLanguageChanged)
        refreshLanguagesList(function () {
            loadSettings();
        });
    });

    function selectedLanguageChanged() {
        var lang = $('select[name="language"] option:selected').val();
        console.log("change lang", lang)
        google.script.run.changeLanguage(lang);
        $('#error').remove();
        $('#results').html("")
    }

    function loadSettings(onSuccess, onFailure) {
        var select = $('select[name="language"]')
        google.script.run
            .withSuccessHandler(
                function (result, element) {
                    element.val(result)
                    if (onSuccess)
                        onSuccess()
                })
            .withFailureHandler(onFailure)
            .withUserObject(select)
            .getSelectedLanguage();
    }

    function refreshLanguagesList(onSuccess, onFailure) {
        var select = $('select[name="language"]')
        google.script.run
            .withSuccessHandler(
                function (result, element) {
                    var languages = result.available.grammar
                    element.empty()
                    for (var lang in languages) {
                        element.append(new Option(languages[lang], lang))
                    }

                    if (onSuccess)
                        onSuccess()
                })
            .withFailureHandler(onFailure)
            .withUserObject(select)
            .apiRequestLanguageOptions();
    }

    function openPreferences() {
        google.script.run
            .withFailureHandler(
                function (msg, element) {
                    showError(msg, $('#button-bar'));
                })
            .withUserObject(this)
            .showPreferences();
    }

    function runGrammarCheck() {
        this.disabled = true;
        $('#error').remove();

        var lang = $('select[name="language"] option:selected').val();
        google.script.run
            .withSuccessHandler(
                function (grammarCheckResultsHtml, element) {
                    element.disabled = false;
                    $('#results').html(grammarCheckResultsHtml);
                    $('.suggestion').click(runCorrection);
                })
            .withFailureHandler(
                function (msg, element) {
                    showError(msg, $('#button-bar'));
                    element.disabled = false;
                })
            .withUserObject(this)
            .runGrammarCheckOnWholeText(lang);
    }

    function runCorrection() {
        var errorText = $(this).attr('data-error-text');
        var correction = $(this).attr('data-correction');
        var parentIndex = $(this).attr('data-parent-index');
        var parent = $(this).closest('.grammar-error');

        google.script.run
            .withSuccessHandler(function () {
                parent.slideUp(300, function () {
                    runGrammarCheck();
                    parent.remove();
                });
            })
            .withFailureHandler(function (message) {
                showError(message, this);
            })
            .withUserObject(this)
            .runCorrection(errorText, correction);
    }

    function showError(msg, element) {
        var div = $('<div id="error" class="error">' + msg + '</div>');
        $(element).after(div);
    }
</script>